name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # Quick build and test on all platforms
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            name: Linux x64
            artifact: pseudo-linux-x64
          - os: macos-14
            name: macOS ARM64
            artifact: pseudo-darwin-arm64
    
    runs-on: ${{ matrix.os }}
    name: Build (${{ matrix.name }})
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y libpcre2-dev
      
      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: brew install pcre2
      
      - name: Build
        run: |
          cd cvm
          export CFLAGS="$(pkg-config --cflags libpcre2-8 2>/dev/null)"
          export LDFLAGS="$(pkg-config --libs libpcre2-8 2>/dev/null || echo '-lpcre2-8')"
          make release
      
      - name: Run tests
        run: |
          cd cvm
          echo "=== Testing basic examples ==="
          ./pseudo ../examples/hello.pseudo
          ./pseudo ../examples/fibonacci.pseudo
          ./pseudo ../examples/factorial.pseudo
          ./pseudo ../examples/fizzbuzz.pseudo
          echo "=== Testing JIT ==="
          ./pseudo -j ../examples/arrays.pseudo
          ./pseudo -j ../examples/fibonacci.pseudo
          echo "=== All tests passed ==="

  # Windows build (separate due to MSYS2)
  build-windows:
    runs-on: windows-latest
    name: Build (Windows x64)
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-pcre2
            make
      
      - name: Build
        shell: msys2 {0}
        run: |
          cd cvm
          # Windows build - fully static for portability (no DLLs needed)
          gcc -O3 -flto -fomit-frame-pointer -DNDEBUG -Wall -Wextra -std=gnu11 \
            -static \
            -o pseudo \
            main.c lexer.c compiler.c vm.c memory.c import.c \
            jit_trace.c trace_recorder.c trace_regalloc.c trace_codegen.c tensor.c \
            -lpcre2-8 -lm
      
      - name: Verify no DLL dependencies
        shell: msys2 {0}
        run: |
          cd cvm
          echo "Checking DLL dependencies..."
          objdump -p pseudo.exe 2>/dev/null | grep "DLL Name" || echo "No DLL dependencies (static build)"
      
      - name: Run tests
        shell: msys2 {0}
        run: |
          cd cvm
          echo "=== Testing basic examples ==="
          ./pseudo ../examples/hello.pseudo
          ./pseudo ../examples/fibonacci.pseudo
          ./pseudo ../examples/factorial.pseudo
          echo "=== All tests passed ==="
