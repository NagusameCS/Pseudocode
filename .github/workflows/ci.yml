name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # Quick build and test on all platforms
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            name: Linux x64
            artifact: pseudo-linux-x64
          - os: macos-14
            name: macOS ARM64
            artifact: pseudo-darwin-arm64
    
    runs-on: ${{ matrix.os }}
    name: Build (${{ matrix.name }})
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y libpcre2-dev
      
      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: brew install pcre2
      
      - name: Build
        run: |
          cd cvm
          export CFLAGS="$(pkg-config --cflags libpcre2-8 2>/dev/null)"
          export LDFLAGS="$(pkg-config --libs libpcre2-8 2>/dev/null || echo '-lpcre2-8')"
          make release
      
      - name: Run tests
        run: |
          cd cvm
          echo "=== Testing basic examples ==="
          ./pseudo ../examples/hello.pseudo
          ./pseudo ../examples/fibonacci.pseudo
          ./pseudo ../examples/factorial.pseudo
          ./pseudo ../examples/fizzbuzz.pseudo
          echo "=== Testing JIT ==="
          ./pseudo -j ../examples/arrays.pseudo
          ./pseudo -j ../examples/fibonacci.pseudo
          echo "=== All tests passed ==="

  # Windows build (separate due to MSYS2)
  build-windows:
    runs-on: windows-latest
    name: Build (Windows x64)
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-make
            make
      
      - name: Build pcre2 from source (static)
        shell: msys2 {0}
        run: |
          # Download and build pcre2 statically
          curl -L https://github.com/PCRE2Project/pcre2/releases/download/pcre2-10.44/pcre2-10.44.tar.gz | tar xz
          cd pcre2-10.44
          cmake -G "MinGW Makefiles" \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=OFF \
            -DPCRE2_BUILD_PCRE2_8=ON \
            -DPCRE2_BUILD_PCRE2_16=OFF \
            -DPCRE2_BUILD_PCRE2_32=OFF \
            -DPCRE2_SUPPORT_JIT=ON \
            -DPCRE2_BUILD_PCRE2GREP=OFF \
            -DPCRE2_BUILD_TESTS=OFF \
            -DCMAKE_INSTALL_PREFIX=/mingw64 \
            .
          mingw32-make -j$(nproc)
          mingw32-make install
      
      - name: Build
        shell: msys2 {0}
        run: |
          cd cvm
          # Windows build - link pcre2 and GCC runtime statically for portability
          # -DPCRE2_STATIC tells pcre2 headers we're linking statically
          # -static-libgcc eliminates libgcc DLL dependency
          gcc -O3 -flto -fomit-frame-pointer -DNDEBUG -DPCRE2_STATIC -Wall -Wextra -std=gnu11 \
            -I/mingw64/include \
            -o pseudo.exe \
            main.c lexer.c compiler.c vm.c memory.c import.c \
            jit_trace.c trace_recorder.c trace_regalloc.c trace_codegen.c tensor.c \
            /mingw64/lib/libpcre2-8.a -lm -static-libgcc
      
      - name: Verify no DLL dependencies
        shell: msys2 {0}
        run: |
          cd cvm
          echo "Checking DLL dependencies..."
          objdump -p pseudo.exe 2>/dev/null | grep "DLL Name" || echo "No DLL dependencies (static build)"
      
      - name: Run tests
        shell: msys2 {0}
        run: |
          cd cvm
          echo "=== Testing basic examples ==="
          ./pseudo.exe ../examples/hello.pseudo
          ./pseudo.exe ../examples/fibonacci.pseudo
          ./pseudo.exe ../examples/factorial.pseudo
          echo "=== All tests passed ==="
