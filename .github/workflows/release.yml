name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create a release with artifacts'
        required: false
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  # ============================================
  # Linux x64 Build
  # ============================================
  build-linux-x64:
    runs-on: ubuntu-22.04
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y libpcre2-dev
      
      - name: Build VM
        run: |
          cd cvm
          # Use portable flags instead of -march=native for distribution
          gcc -O3 -flto -fomit-frame-pointer -DNDEBUG -Wall -Wextra -std=gnu11 \
            -o pseudo-linux-x64 \
            main.c lexer.c compiler.c vm.c memory.c import.c \
            jit_trace.c trace_recorder.c trace_regalloc.c trace_codegen.c tensor.c \
            -lm -lpcre2-8
      
      - name: Test binary
        run: |
          cd cvm
          ./pseudo-linux-x64 ../examples/hello.pseudo
          ./pseudo-linux-x64 ../examples/fibonacci.pseudo
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: pseudo-linux-x64
          path: cvm/pseudo-linux-x64

  # ============================================
  # macOS ARM64 Build (Apple Silicon)
  # ============================================
  build-macos-arm64:
    runs-on: macos-14  # M1 runner
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: brew install pcre2
      
      - name: Build VM
        run: |
          cd cvm
          # ARM64 optimized build with pkg-config for pcre2
          clang -O3 -flto -fomit-frame-pointer -DNDEBUG -Wall -Wextra -std=gnu11 \
            $(pkg-config --cflags libpcre2-8) \
            -o pseudo-darwin-arm64 \
            main.c lexer.c compiler.c vm.c memory.c import.c \
            jit_trace.c trace_recorder.c trace_regalloc.c trace_codegen.c tensor.c \
            -lm $(pkg-config --libs libpcre2-8)
      
      - name: Test binary
        run: |
          cd cvm
          ./pseudo-darwin-arm64 ../examples/hello.pseudo
          ./pseudo-darwin-arm64 ../examples/fibonacci.pseudo
          # Test JIT on ARM64
          ./pseudo-darwin-arm64 -j ../examples/arrays.pseudo
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: pseudo-darwin-arm64
          path: cvm/pseudo-darwin-arm64

  # ============================================
  # macOS x64 Build (Intel)
  # NOTE: Skipped - macos-13 is retired, macos-15-large requires billing
  # Users on Intel Macs can build from source
  # ============================================
  # build-macos-x64:
  #   runs-on: macos-13  # Retired

  # ============================================
  # Windows x64 Build
  # ============================================
  build-windows-x64:
    runs-on: windows-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-make
            make
      
      - name: Build pcre2 from source (static)
        shell: msys2 {0}
        run: |
          # Download and build pcre2 statically
          curl -L https://github.com/PCRE2Project/pcre2/releases/download/pcre2-10.44/pcre2-10.44.tar.gz | tar xz
          cd pcre2-10.44
          cmake -G "MinGW Makefiles" \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=OFF \
            -DPCRE2_BUILD_PCRE2_8=ON \
            -DPCRE2_BUILD_PCRE2_16=OFF \
            -DPCRE2_BUILD_PCRE2_32=OFF \
            -DPCRE2_SUPPORT_JIT=ON \
            -DPCRE2_BUILD_PCRE2GREP=OFF \
            -DPCRE2_BUILD_TESTS=OFF \
            -DCMAKE_INSTALL_PREFIX=/mingw64 \
            .
          mingw32-make -j$(nproc)
          mingw32-make install
      
      - name: Build VM
        shell: msys2 {0}
        run: |
          cd cvm
          # Windows x64 build - link pcre2 and GCC runtime statically for portability
          # -DPCRE2_STATIC tells pcre2 headers we're linking statically
          # -static-libgcc eliminates libgcc DLL dependency
          gcc -O3 -flto -fomit-frame-pointer -DNDEBUG -DPCRE2_STATIC -Wall -Wextra -std=gnu11 \
            -I/mingw64/include \
            -o pseudo-win32-x64.exe \
            main.c lexer.c compiler.c vm.c memory.c import.c \
            jit_trace.c trace_recorder.c trace_regalloc.c trace_codegen.c tensor.c \
            /mingw64/lib/libpcre2-8.a -lm -static-libgcc
      
      - name: Verify no DLL dependencies
        shell: msys2 {0}
        run: |
          cd cvm
          echo "Checking DLL dependencies..."
          objdump -p pseudo-win32-x64.exe | grep "DLL Name" || echo "No DLL dependencies (good!)"
      
      - name: Test binary
        shell: msys2 {0}
        run: |
          cd cvm
          ./pseudo-win32-x64.exe ../examples/hello.pseudo
          ./pseudo-win32-x64.exe ../examples/fibonacci.pseudo
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: pseudo-win32-x64
          path: cvm/pseudo-win32-x64.exe

  # ============================================
  # Create Release (only on tags or manual trigger)
  # ============================================
  create-release:
    needs: [build-linux-x64, build-macos-arm64, build-windows-x64]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true')
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Prepare release files
        run: |
          mkdir release
          cp artifacts/pseudo-linux-x64/pseudo-linux-x64 release/
          cp artifacts/pseudo-darwin-arm64/pseudo-darwin-arm64 release/
          cp artifacts/pseudo-win32-x64/pseudo-win32-x64.exe release/
          chmod +x release/pseudo-*
          ls -la release/
      
      - name: Create checksums
        run: |
          cd release
          sha256sum * > checksums.txt
          cat checksums.txt
      
      - name: Get version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "version=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          else
            echo "version=dev-$(date +%Y%m%d)-$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          fi
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Pseudocode ${{ steps.version.outputs.version }}
          files: release/*
          draft: false
          prerelease: ${{ !startsWith(github.ref, 'refs/tags/') }}
          body: |
            ## Pseudocode ${{ steps.version.outputs.version }}
            
            ### Download
            | Platform | Architecture | Binary |
            |----------|--------------|--------|
            | Linux    | x64          | `pseudo-linux-x64` |
            | macOS    | ARM64 (Apple Silicon) | `pseudo-darwin-arm64` |
            | Windows  | x64          | `pseudo-win32-x64.exe` |
            
            > **Note:** macOS x64 (Intel) builds are not included. Intel Mac users can build from source.
            
            ### Installation
            
            **Linux/macOS:**
            ```bash
            chmod +x pseudo-*
            sudo mv pseudo-* /usr/local/bin/pseudo
            ```
            
            **Windows:**
            Add the directory containing `pseudo-win32-x64.exe` to your PATH.
            
            ### Features
            - High-performance bytecode VM
            - Tracing JIT compiler (x64 and ARM64)
            - 80+ built-in functions
            - Pattern matching, classes, lambdas
            
            ### VS Code Extension
            Install from the VS Code Marketplace or build from source:
            ```bash
            cd vscode-extension && npm install && npx @vscode/vsce package
            ```
