name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-22.04
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install PCRE2
        run: sudo apt-get update && sudo apt-get install -y libpcre2-dev
      
      - name: Build VM
        run: |
          cd cvm
          make release
      
      - name: Rename binary
        run: mv cvm/pseudo cvm/pseudo-linux-x64
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: pseudo-linux-x64
          path: cvm/pseudo-linux-x64

  create-release:
    needs: build-linux
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Download Linux binary
        uses: actions/download-artifact@v4
        with:
          name: pseudo-linux-x64
          path: artifacts
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/*
          draft: false
          prerelease: false
          body: |
            ## Pseudocode ${{ github.ref_name }}
            
            ### VM Binaries
            - **Linux x64**: `pseudo-linux-x64` (included)
            - **macOS/Windows**: Run `scripts/build-mac.sh` or `scripts/build-windows.sh`
            
            ### VS Code Extension
            Build locally with: `cd vscode-extension && npm install && npx @vscode/vsce package`
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
